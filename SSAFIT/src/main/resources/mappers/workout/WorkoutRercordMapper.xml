<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafit.domain.workout.dao.WorkoutRecordDao">

    <sql id="recordColumns">
        id,
        user_id,
        video_id,
        start_time,
        end_time,
        user_satisfaction,
        personal_difficulty,
        user_memo,
        is_success
    </sql>

    <!-- INSERT: 운동 시작 기록 생성 -->
    <insert id="insertRecord" parameterType="WorkoutRecord"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO workout_record (
            user_id,
            video_id,
            start_time,
            end_time,
            user_satisfaction,
            personal_difficulty,
            user_memo,
            is_success
        )
        VALUES (
            #{userId},
            #{videoId},
            #{startTime},
            #{endTime},
            #{userSatisfaction},
            #{personalDifficulty},
            #{userMemo},
            #{isSuccess}
        )
    </insert>

    <!-- SELECT: 단일 기록 조회 -->
    <select id="selectById" resultType="WorkoutRecord">
        SELECT
            <include refid="recordColumns"/>
        FROM workout_record
        WHERE id = #{id}
    </select>

    <!-- SELECT: 내 기록 목록 조회 -->
    <select id="selectByUserId" resultType="WorkoutRecord">
        SELECT
            <include refid="recordColumns"/>
        FROM workout_record
        WHERE user_id = #{userId}
        ORDER BY COALESCE(end_time, start_time) DESC
    </select>

    <!-- UPDATE: 운동 종료/수정 -->
    <update id="updateRecord" parameterType="WorkoutRecord">
        UPDATE workout_record
        SET
            start_time = #{startTime},
            end_time = #{endTime},
            user_satisfaction = #{userSatisfaction},
            personal_difficulty = #{personalDifficulty},
            user_memo = #{userMemo},
            is_success = #{isSuccess}
        WHERE id = #{id}
    </update>

    <!-- EXISTS: 진행 중 운동 존재 여부 -->
    <select id="existsOngoing" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM workout_record
        WHERE user_id = #{userId}
          AND end_time IS NULL
    </select>
    
    <!-- EXISTS: 특정 날짜에 성공한 운동 여부 (스트릭 계산) -->
	<select id="existsSuccessOnDate" resultType="boolean">
	    SELECT COUNT(*) > 0
	    FROM workout_record
	    WHERE user_id = #{userId}
	      AND is_success = true
	      AND DATE(end_time) = #{date}
	</select>
    

</mapper>
