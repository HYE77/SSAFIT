<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafit.domain.dashboard.dao.DashboardDao">

    <!-- 월 단위 운동한 날짜 조회 -->
    <select id="selectWorkoutDatesInMonth" resultType="java.time.LocalDate">
        SELECT DISTINCT DATE(start_time)
        FROM workout_record
        WHERE user_id = #{userId}
          AND is_success = true
          AND start_time BETWEEN #{start} AND #{end}
    </select>
    
    <!-- 날짜 별 운동 기록 조회 -->
    <select id="selectRecordsByDate"
        resultType="com.ssafit.domain.dashboard.dto.WorkoutRecordRow">
	    SELECT
	        wr.id            AS recordId,
	        v.id             AS videoId,
	        v.title          AS videoTitle,
	        v.duration_seconds AS durationSeconds,
	        v.calorie_estimate AS calorieEstimate,
	        wr.is_success    AS success
	    FROM workout_record wr
	    JOIN video v ON wr.video_id = v.id
	    WHERE wr.user_id = #{userId}
	      AND DATE(wr.start_time) = #{date}
	      AND wr.is_success = true
	</select>
	
	
	<!-- 주간 운동 기록 조회 & 통합 -->
	<select id="selectWeeklyAggregate"
        resultType="com.ssafit.domain.dashboard.dto.WeeklyAggregateRow">
	    SELECT
	        COUNT(DISTINCT DATE(wr.start_time))          AS workoutDays,
	        SUM(v.duration_seconds) / 60                AS totalMinutes,
	        SUM(v.calorie_estimate)                     AS totalCalories,
	        AVG(wr.user_satisfaction)                   AS avgSatisfaction,
	        AVG(wr.personal_difficulty)                 AS avgDifficulty
	    FROM workout_record wr
	    JOIN video v ON wr.video_id = v.id
	    WHERE wr.user_id = #{userId}
	      AND wr.is_success = true
	      AND wr.start_time BETWEEN #{start} AND #{end}
	</select>
	
	
	<!-- 월간 운동 기록 조회 & 통합 -->
	<select id="selectMonthlyAggregate"
        resultType="com.ssafit.domain.dashboard.dto.WeeklyAggregateRow">

	    SELECT
	        COUNT(DISTINCT DATE(start_time)) AS workoutDays,
	        SUM(v.duration_seconds / 60) AS totalMinutes,
	        SUM(v.calorie_estimate) AS totalCalories,
	        AVG(w.user_satisfaction) AS avgSatisfaction,
	        AVG(w.personal_difficulty) AS avgDifficulty
	    FROM workout_record w
	    JOIN video v ON w.video_id = v.id
	    WHERE w.user_id = #{userId}
	      AND w.is_success = TRUE
	      AND YEAR(w.start_time) = #{year}
	      AND MONTH(w.start_time) = #{month}
	
	</select>
	
	
    

</mapper>
